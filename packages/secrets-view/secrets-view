#!/usr/bin/env bun
/**
 * Secrets View - Interactive TUI for browsing AWS Secrets Manager
 */

import {
  SecretsManagerClient,
  ListSecretsCommand,
  GetSecretValueCommand,
} from "@aws-sdk/client-secrets-manager";
import {
  colors as pc,
  prompts as p,
  getAwsClientConfig,
  fetchAndDisplayIdentity,
  withSpinner,
  selectFromList,
  copyWithFeedback,
  formatJson,
  divider,
  runApp,
  goodbye,
} from "@toolbox/common";

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Types
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface SecretInfo {
  name: string;
  arn: string;
  description?: string;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Secrets Operations
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function listSecrets(client: SecretsManagerClient): Promise<SecretInfo[]> {
  const secrets: SecretInfo[] = [];
  let nextToken: string | undefined;

  do {
    const cmd = new ListSecretsCommand({ NextToken: nextToken, MaxResults: 100 });
    const resp = await client.send(cmd);

    for (const secret of resp.SecretList || []) {
      if (!secret.Name || !secret.ARN) continue;
      secrets.push({
        name: secret.Name,
        arn: secret.ARN,
        description: secret.Description,
      });
    }
    nextToken = resp.NextToken;
  } while (nextToken);

  return secrets.sort((a, b) => a.name.localeCompare(b.name));
}

async function getSecretValue(client: SecretsManagerClient, secretId: string): Promise<string> {
  const cmd = new GetSecretValueCommand({ SecretId: secretId });
  const resp = await client.send(cmd);
  return resp.SecretString || "(binary secret)";
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Formatters
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function formatSecret(secret: SecretInfo): string {
  const name = pc.bold(secret.name);
  const desc = secret.description ? pc.dim(` - ${secret.description.slice(0, 40)}`) : "";
  return `${name}${desc}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Secret Actions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function showSecretActions(client: SecretsManagerClient, secret: SecretInfo): Promise<boolean> {
  const value = await withSpinner(
    () => getSecretValue(client, secret.arn),
    {
      start: `Fetching ${secret.name}...`,
      success: () => "Secret loaded",
      error: "Failed to fetch secret",
    }
  );

  const formatted = formatJson(value);

  console.log();
  console.log(divider());
  console.log(pc.cyan(secret.name));
  console.log(divider());
  console.log(formatted);
  console.log(divider());
  console.log();

  const action = await p.select({
    message: "What would you like to do?",
    options: [
      { value: "copy", label: "Copy to clipboard" },
      { value: "copy-field", label: "Copy specific field (if JSON)" },
      { value: "back", label: "Back to list" },
      { value: "exit", label: "Exit" },
    ],
  });

  if (p.isCancel(action) || action === "exit") return false;

  if (action === "copy") {
    await copyWithFeedback(value, "secret");
    return true;
  }

  if (action === "copy-field") {
    try {
      const parsed = JSON.parse(value);
      const keys = Object.keys(parsed);

      if (keys.length === 0) {
        p.log.warn("No fields found in secret");
        return true;
      }

      const field = await p.select({
        message: "Select field to copy:",
        options: keys.map((k) => ({
          value: k,
          label: `${k}: ${pc.dim(String(parsed[k]).slice(0, 30))}`,
        })),
      });

      if (!p.isCancel(field)) {
        await copyWithFeedback(String(parsed[field as string]), field as string);
      }
    } catch {
      p.log.warn("Secret is not JSON - use 'Copy to clipboard' instead");
    }
    return true;
  }

  return true;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Main
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

runApp({ name: "ðŸ” Secrets View", color: pc.bgMagenta }, async () => {
  const client = new SecretsManagerClient(getAwsClientConfig());

  await fetchAndDisplayIdentity();

  const secrets = await withSpinner(
    () => listSecrets(client),
    {
      start: "Fetching secrets...",
      success: (r) => `Found ${pc.bold(r.length)} secret(s)`,
      error: "Failed to fetch secrets",
    }
  );

  let continueLoop = true;
  while (continueLoop) {
    const selected = await selectFromList(secrets, {
      message: "Select a secret:",
      formatLabel: formatSecret,
      emptyMessage: "No secrets found in this account/region.",
    });

    if (!selected) break;

    try {
      continueLoop = await showSecretActions(client, selected);
    } catch {
      continueLoop = true;
    }
  }

  goodbye();
});
